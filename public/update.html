<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="style.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="Clapper.png" />
    <title>Update Movie</title>
  </head>  

  <body>
    <div class = 'back-container'>
        <button class = "back-button" onclick = "window.location.href='index.html'">
            Back
        </button>
    </div>
    <h1>Update Data</h1>

    <div class="form-container">
        <label><strong>Select Action:</strong></label>
        <select id = "modeSelect" onchange = "updatemode()">
            <option value = "movie">Update Movie</option>
            <option value = "person">Update Person</option>
            <option value = "both">Update Movie + Person</option>
        </select>

        <hr />

        <div id = "movieSection">
            //select an existing movie and update its info WIP
            <h2>Update Movie</h2>
            <select id="movieSelect">
                <option value="">-- Select Movie --</option>
            </select>

            <label>Title:</label>
            <input type="text" id="title" />
            
            <label>Release Date:</label>
            <input type="date" id="release_date" />

            <label>Runtime (minutes):</label>
            <input type="number" id="run_time" min="1" />

            <label>Rating (0 - 100):</label>
            <input type="number" id="rating" min="0" max="100" />

            <label>Category:</label>
            <input type="text" id="category" />

            <label>Synopsis:</label>
            <textarea id="synopsis"></textarea>

        </div>

        <div id = "personSection" style = "display: none">
            //select an existing person and update their info or add a link to another movie WIP
            <h2>Update Person</h2>
            <select id = "personSelect">
                <option value=''>-- Select Person --</option>
            </select>

            <label>Person Type:</label>
            <select id="person_type" onchange="loadPersonFields()">
                <option value="">-- Select Type --</option>
                <option value="actor">Actor</option>
                <option value="actress">Actress</option>
                <option value="director">Director</option>
                <option value="writer">Writer</option>
                <option value="producer">Producer</option>
            </select>

            <label>First Name:</label>
            <input type="text" id="first_name" />

            <label>Last Name:</label>
            <input type="text" id="last_name" />

            <label>Pay Amount:</label>
            <input type="number" id="pay" min="0" />

            <label>Add Person to Existing Movie (optional):</label>
            <select id="movieSelect">
                <option value="">-- Do Not Link to a Movie --</option>
            </select>

            <div id="role_fields"></div>

        </div>

        <hr />

        <button onclick = "updateData()">Update</button>

        <script>
            async function loadMovies() {
                const res = await fetch("/api/movies");
                const movies = await res.json();

                const movieDropdowns = [
                    document.getElementById("movieSelect"),
                ];

                movieDropdowns.forEach((dropdown) => {
                    dropdown.innerHTML = `<option value="">-- Select Movie --</option>`;
                    movies.forEach((m) => {
                        const opt = document.createElement("option");
                        opt.value = m.movie_id;
                        opt.textContent = `${m.title} (${m.movie_id})`;
                        dropdown.appendChild(opt);
                    });
                });
            }

            async function loadPersons() {
                const res = await fetch("/api/persons");
                const persons = await res.json();

                const personDropdowns = [
                    document.getElementById("personSelect"),
                ];

                personDropdowns.forEach((dropdown) => {
                    dropdown.innerHTML = `<option value="">-- Select Person --</option>`;
                    persons.forEach((m) => {
                        const opt = document.createElement("option");
                        opt.value = p.person_id;
                        opt.textContent = `${p.first_name} ${p.last_name} (${p.person_id})`;
                        dropdown.appendChild(opt);
                    });
                });
            }

            loadMovies();
            loadPersons();

            function updateMode() {
                const mode = document.getElementById("modeSelect").value;

                document.getElementById("movieSection").style.display =
                mode === "movie" || mode === "both" ? "block" : "none";

                document.getElementById("personSection").style.display =
                mode === "person" || mode === "both" ? "block" : "none";
            }

            function loadPersonFields() {
                const type = document.getElementById("person_type").value;
                const container = document.getElementById("role_fields");
                container.innerHTML = "";

                if (type === "actor" || type === "actress") {
                    container.innerHTML = `
                    <label>Role:</label>
                    <input type="text" id="role" />
                    `;
                } else if (type === "writer") {
                    container.innerHTML = `
                    <label>Contribution:</label>
                    <input type="text" id="contribution" />
                    `;
                } else if (type === "director" || type === "producer") {
                    container.innerHTML = `
                    <label>Position:</label>
                    <input type="text" id="position" />
                    `;
                }
            }

            async function loadMovieList() {
                const res = await fetch("/api/movies");
                const movies = await res.json();

                const dropdown = document.getElementById("movieSelect");
                dropdown.innerHTML = `
                <option value="">-- Do Not Link to a Movie --</option>
                `;
        
                movies.forEach((m) => {
                    const opt = document.createElement("option");
                    opt.value = m.movie_id;
                    opt.textContent = `${m.movie_id} â€” ${m.title}`;
                    dropdown.appendChild(opt);
                });
            }
            
            loadMovieList();

            async function updateData() {
                const mode = document.getElementById("modeSelect").value;
                
                const movie = {
                    title: document.getElementById("title").value,
                    release_date: document.getElementById("release_date").value,
                    synopsis: document.getElementById("synopsis").value,
                    rating: document.getElementById("rating").value,
                    run_time: document.getElementById("run_time").value,
                    category: document.getElementById("category").value,
                };

                const person = {
                    type: document.getElementById("person_type").value,
                    first_name: document.getElementById("first_name").value,
                    last_name: document.getElementById("last_name").value,
          
                    pay: document.getElementById("pay").value,          
                    role: document.getElementById("role")?.value || null,  
                    contribution: document.getElementById("contribution")?.value || null,          
                    position: document.getElementById("position")?.value || null,
                };

                if (mode === "movie") {
                    if (!movie.title) return alert("Movie title required.");
                    return updateMovieOnly(movie);
                }

                if (mode === "person") {
                    if (!person.first_name || !person.last_name || !person.type)
                       return alert("Person information incomplete.");
                    return updatePersonOnly(person);
                }

                if (mode === "both") {
                    if (!movie.title) return alert("Movie title required.");
                    if (!person.type || !person.first_name || !person.last_name)
                      return alert("Person info required.");
                    return updateMovieAndPerson(movie, person);
                }
            }

            async function updateMovieOnly(movie) {
                const res = await fetch("/api/movie", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(movie),
                });

                const data = await res.json();
                alert("Movie updated with ID: " + data.movie_id); //change later
            }

            async function updatePersonOnly(person) {
                const movieId = document.getElementById("movieSelect").value;

                const res = await fetch("/api/person", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ person, movie_id: movieId }),
                });

                const data = await res.json();
                alert(data.message || "Person updated.");
            }

            async function updateMovieAndPerson(movie, person) {
                const res = await fetch("/api/updateMovieAndPerson", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ movie, person }),
                });

                const data = await res.json();
                alert(data.message || "Movie and Person updated.");
            }
        </script>
    </div>
  </body>